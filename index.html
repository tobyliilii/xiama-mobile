<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å»ˆé–€éº»å°‡ï½œæ°´è¡¨æŸ¥è¡¨çµç®—å™¨ï¼ˆæ¸¸é‡‘/å¤œé–“ï¼‰</title>
  <style>
    :root{
      --bg:#fafafa;
      --text:#111;
      --muted:#666;
      --card:#fff;
      --border:#ddd;
      --btn:#f3f3f3;
      --tableBorder:#eee;
      --badgeBg:#f5e7a1;
      --badgeText:#513d00;

      --radius:16px;
      --radiusSm:12px;
      --shadow: 0 6px 24px rgba(0,0,0,.06);
    }

    [data-theme="dark"]{
      --bg:#0b0f14;
      --text:#e8eef6;
      --muted:#9aa6b2;
      --card:#0f1620;
      --border:#243244;
      --btn:#162233;
      --tableBorder:#1e2a3a;
      --badgeBg:#2b2a12;
      --badgeText:#f2d26b;

      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",system-ui,sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
      padding-bottom: calc(92px + env(safe-area-inset-bottom)); /* çµ¦åº•éƒ¨æ“ä½œåˆ— */
    }

    .app{
      max-width: 780px;
      margin: 0 auto;
      padding: 18px 16px 22px;
    }

    h1{margin:8px 0 6px; font-size:22px; line-height:1.2;}
    .muted{color:var(--muted);font-size:13px; line-height:1.55;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin:14px 0;
      box-shadow: var(--shadow);
    }

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

    /* è§¸æ§å‹å–„ï¼šè‡³å°‘ 44px é«˜ï¼›å­—é«” 16px é¿å… iOS è‡ªå‹•æ”¾å¤§ */
    input,select,button{
      padding:12px 12px;
      border-radius:var(--radiusSm);
      border:1px solid var(--border);
      font-size:16px;
      background:var(--card);
      color:var(--text);
      min-height:44px;
    }

    input[type="number"]{width:160px}
    input[type="text"]{width:160px}
    button{
      cursor:pointer;
      background:var(--btn);
      font-weight:600;
    }
    button:active{ transform: translateY(1px); }

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--tableBorder);padding:10px 8px;text-align:left;vertical-align:top}
    th{font-size:13px;color:var(--muted);font-weight:700}
    .warn{color:#ff6b6b;font-size:13px;margin-top:8px}
    .ok{color:#3ddc84;font-size:13px;margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      background:var(--badgeBg);
      color:var(--badgeText);
      border:1px solid var(--border);
      margin-left:6px;
      line-height:1.6;
      vertical-align: middle;
    }

    /* å°ä¸€é»çš„å¡ç‰‡ï¼ˆçµ¦æ¯å±€ç´€éŒ„ç”¨ï¼Œæ¸›å°‘â€œå¡ç‰‡å¥—å¡ç‰‡â€çš„å£“è¿«æ„Ÿï¼‰ */
    .roundCard{
      box-shadow:none;
      padding:14px;
      margin-top:10px;
      border-radius:14px;
    }
    .roundHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .roundTitle{
      font-size:14px;
      line-height:1.35;
    }
    .roundLines{
      margin-top:10px;
      font-size:13px;
      line-height:1.55;
      word-break: break-word;
    }
    .roundHeader button{
      padding:10px 12px;
      min-height:40px;
      border-radius:12px;
      font-size:14px;
      white-space:nowrap;
    }

    /* æ‰‹æ©Ÿï¼šä¸€æ¬„åˆ°åº• + è¼¸å…¥å…¨å¯¬ */
    @media (max-width: 520px){
      .app{ padding: 14px 12px 18px; }
      h1{ font-size:20px; }
      .card{ padding:14px; margin:12px 0; }
      .row{ display:block; }
      .row > div{ width:100%; margin-bottom:10px; }
      input[type="number"], input[type="text"], select{ width:100%; }
      button{ width:100%; }
      .roundHeader{ flex-direction:column; align-items:stretch; }
      .roundHeader button{ width:100%; }
      table{ display:block; overflow:auto; -webkit-overflow-scrolling:touch; }
    }

    /* åº•éƒ¨å›ºå®šæ“ä½œåˆ—ï¼ˆå–®æ‰‹ç¥å™¨ï¼‰ */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.72);
      border-top: 1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(12px);
      z-index: 50;
    }
    [data-theme="dark"] .bottomBar{
      background: rgba(15,22,32,.72);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .bottomGrid{
      max-width: 780px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
    }
    .bottomPrimary{
      min-height:52px;
      border-radius: 16px;
      font-size:16px;
      font-weight:800;
    }
    .bottomIcon{
      min-width: 54px;
      min-height:52px;
      border-radius: 16px;
      font-size:18px;
      padding: 0 14px;
    }

    /* è®“é»æ“Šæ›´â€œåƒ Appâ€ */
    button, select, input{
      touch-action: manipulation;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>å»ˆé–€éº»å°‡ï½œæ°´è¡¨æŸ¥è¡¨çµç®—å™¨</h1>
    <div class="muted">
      è¦å‰‡ï¼šä¸è«–åˆ°/è‡ªæ‘¸/å–®æ¸¸/é›™æ¸¸ï¼Œéƒ½æ˜¯ <b>ä¸‰å®¶è³ </b>ï¼›æ¯å€‹è¼¸å®¶ä»˜å¤šå°‘åªçœ‹ã€Œè¼¸å®¶æ˜¯ä¸æ˜¯èŠå®¶ã€â†’ æŸ¥è¡¨ç”¨ åº„/å¹³ æ¬„ä½ã€‚<br/>
      æ¸¸é‡‘ï¼šæœ¬å±€è‹¥æœ‰æ¸¸é‡‘ â†’ é™¤äº†æ¸¸é‡‘è€…æœ¬äººä»¥å¤–ï¼Œæ¯å€‹äººé¡å¤–ä»˜å›ºå®šé‡‘é¡ï¼ˆé è¨­ $10ï¼‰çµ¦æ¸¸é‡‘è€…ã€‚<br/>
      ï¼ˆæç¤ºï¼šæœ¬é é è¨­æ·±å¤œæ¨¡å¼ï¼Œå¯åˆ‡æ›å›æ—¥é–“ï¼‰
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>ç©å®¶æ•¸</label>
          <select id="playerCount">
            <option value="4" selected>4</option>
            <option value="3">3</option>
          </select>
        </div>

        <div id="namesRow" class="row"></div>

        <div>
          <label>é‡‘é¡å€ç‡ï¼ˆå¯ä¸å‹•ï¼‰</label>
          <input id="scale" type="number" value="1" step="0.1" />
        </div>

        <div>
          <button id="themeBtn">â˜€ï¸ æ—¥é–“æ¨¡å¼</button>
        </div>

        <div>
          <button id="resetBtn">é‡ç½®ç‰Œå±€</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        è‹¥ä½ å€‘æ°´è¡¨ä¸Šçš„æ•¸å­—å°±æ˜¯ã€Œæœ€çµ‚é‡‘é¡ã€ï¼Œå€ç‡ç¶­æŒ 1ï¼›å¦‚æœè¦æ›æˆåˆ¥çš„å¹£å€¼æˆ–å€æ•¸ï¼Œæ”¹å€ç‡å³å¯ã€‚
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>æœ¬å±€èŠå®¶</label>
          <select id="dealerSel"></select>
        </div>
        <div>
          <label>æœ¬å±€è´å®¶</label>
          <select id="winnerSel"></select>
        </div>
        <div>
          <label>è´æ³•</label>
          <select id="typeSel">
            <option value="dao">åˆ°ï¼ˆèƒ¡ç‰Œï¼‰</option>
            <option value="zimo">è‡ªæ‘¸</option>
            <option value="danyou">å–®æ¸¸</option>
            <option value="shuangyou">é›™æ¸¸</option>
          </select>
        </div>
        <div>
          <label>æ°´</label>
          <select id="waterSel"></select>
        </div>

        <div>
          <label>æ¸¸é‡‘</label>
          <select id="youSel">
            <option value="none" selected>ç„¡</option>
            <option value="yes">æœ¬å±€æœ‰æ¸¸é‡‘</option>
          </select>
        </div>

        <div id="youWhoWrap" style="display:none;">
          <label>æ¸¸é‡‘è€…</label>
          <select id="youWhoSel"></select>
        </div>

        <div id="youAmtWrap" style="display:none;">
          <label>æ¯äººåŠ çµ¦ï¼ˆå…ƒï¼‰</label>
          <input id="youAmt" type="number" value="10" step="1" />
        </div>

        <div>
          <button id="addRoundBtn">è¨˜éŒ„æœ¬å±€</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        æœ¬å±€æœƒè‡ªå‹•ç”Ÿæˆ 3 ç­†ï¼ˆæˆ– 2 ç­†ï¼‰ä»˜æ¬¾ï¼šæ¯å€‹è¼¸å®¶ â†’ è´å®¶ã€‚<br/>
        ã€Œå–®æ¸¸/é›™æ¸¸ã€æ°´=0 åœ¨ä½ æ°´è¡¨æ˜¯ç„¡æ•ˆï¼ˆâ€”ï¼‰ï¼Œæœ¬å·¥å…·æœƒè‡ªå‹•ç¦æ­¢é¸ 0ã€‚<br/>
        è‹¥é¸ã€Œæœ¬å±€æœ‰æ¸¸é‡‘ã€ï¼Œæœƒé¡å¤–ç”Ÿæˆã€Œæ¯äºº â†’ æ¸¸é‡‘è€…ã€åŠ çµ¦æ¬¾é …ï¼ˆä¸ä¹˜å€ç‡ï¼‰ã€‚
      </div>
    </div>

    <div class="card">
      <strong>æœ¬å±€ç´€éŒ„</strong>
      <div id="roundList" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div><strong>ç¸½è¨ˆï¼ˆæ°´è¡¨ï¼‰</strong></div>
        <button id="clearRoundsBtn">æ¸…ç©ºå…¨éƒ¨å±€æ•¸</button>
      </div>
      <div id="totalsArea"></div>
      <div style="margin-top:12px;"><strong>å»ºè­°è½‰å¸³æ¸…å–®ï¼ˆæœ€å°‘ç­†æ•¸ï¼‰</strong></div>
      <div id="transfersArea"></div>
    </div>
  </div>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œåˆ— -->
  <div class="bottomBar">
    <div class="bottomGrid">
      <button class="bottomPrimary" id="addRoundBtnBottom">ï¼‹ è¨˜éŒ„æœ¬å±€</button>
      <button class="bottomIcon" id="themeBtnBottom" title="åˆ‡æ›æ—¥/å¤œ">ğŸŒ™</button>
      <button class="bottomIcon" id="resetBtnBottom" title="é‡ç½®">â†º</button>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ---- Theme (Default: Dark) ----
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
    $("themeBtn").textContent = theme === "dark" ? "â˜€ï¸ æ—¥é–“æ¨¡å¼" : "ğŸŒ™ æ·±å¤œæ¨¡å¼";
    // åº•éƒ¨ icon æç¤º
    if ($("themeBtnBottom")) $("themeBtnBottom").textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
  }
  function initTheme(){
    const saved = localStorage.getItem("theme");
    if (saved === "dark" || saved === "light") applyTheme(saved);
    else applyTheme("dark");
  }

  // ---- Lookup Table ----
  const LOOKUP = {
    dao: {
      0:{åº„:16, å¹³:8},  1:{åº„:17, å¹³:9},  2:{åº„:18, å¹³:10}, 3:{åº„:19, å¹³:11},
      4:{åº„:20, å¹³:12}, 5:{åº„:21, å¹³:13}, 6:{åº„:22, å¹³:14}, 7:{åº„:23, å¹³:15},
      8:{åº„:24, å¹³:16}, 9:{åº„:25, å¹³:17}, 10:{åº„:26, å¹³:18}, 11:{åº„:27, å¹³:19}, 12:{åº„:28, å¹³:20}
    },
    zimo: {
      0:{åº„:32, å¹³:16}, 1:{åº„:34, å¹³:18}, 2:{åº„:36, å¹³:20}, 3:{åº„:38, å¹³:22},
      4:{åº„:40, å¹³:24}, 5:{åº„:42, å¹³:26}, 6:{åº„:44, å¹³:28}, 7:{åº„:46, å¹³:30},
      8:{åº„:48, å¹³:32}, 9:{åº„:50, å¹³:34}, 10:{åº„:52, å¹³:36}, 11:{åº„:54, å¹³:38}, 12:{åº„:56, å¹³:40}
    },
    danyou: {
      1:{åº„:68, å¹³:36}, 2:{åº„:72, å¹³:40}, 3:{åº„:76, å¹³:44}, 4:{åº„:80, å¹³:48},
      5:{åº„:84, å¹³:52}, 6:{åº„:88, å¹³:56}, 7:{åº„:92, å¹³:60}, 8:{åº„:96, å¹³:64},
      9:{åº„:100, å¹³:68}, 10:{åº„:104, å¹³:72}, 11:{åº„:108, å¹³:76}, 12:{åº„:112, å¹³:80}
    },
    shuangyou: {
      1:{åº„:136, å¹³:72}, 2:{åº„:144, å¹³:80}, 3:{åº„:152, å¹³:88}, 4:{åº„:160, å¹³:96},
      5:{åº„:168, å¹³:104}, 6:{åº„:176, å¹³:112}, 7:{åº„:184, å¹³:120}, 8:{åº„:192, å¹³:128},
      9:{åº„:200, å¹³:136}, 10:{åº„:208, å¹³:144}, 11:{åº„:216, å¹³:152}, 12:{åº„:224, å¹³:160}
    }
  };

  let players = ["A","B","C","D"];
  let rounds = [];

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function fmtMoney(x){
    const n = Math.round((x + Number.EPSILON) * 100) / 100;
    return n.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2});
  }
  function buildOptions(sel){
    sel.innerHTML = players.map((p,i)=>`<option value="${i}">${escapeHtml(p)}</option>`).join("");
  }

  function renderNames(){
    const n = Number($("playerCount").value);
    players = players.slice(0,n);
    while(players.length<n) players.push(String.fromCharCode(65+players.length));

    $("namesRow").innerHTML = players.map((p,i)=>`
      <div>
        <label>ç©å®¶ ${i+1}</label>
        <input type="text" value="${escapeHtml(p)}" data-name="${i}">
      </div>
    `).join("");

    document.querySelectorAll("[data-name]").forEach(inp=>{
      inp.addEventListener("input",(e)=>{
        const i = Number(e.target.dataset.name);
        players[i] = e.target.value || `ç©å®¶${i+1}`;
        renderSelectors();
        renderAll();
      });
    });
  }

  function renderWaterOptions(){
    const type = $("typeSel").value;
    const waterSel = $("waterSel");
    const keys = Object.keys(LOOKUP[type]).map(Number).sort((a,b)=>a-b);

    waterSel.innerHTML = keys.map(k=>`<option value="${k}">${k}</option>`).join("");
    waterSel.value = (type === "danyou" || type === "shuangyou") ? "1" : "0";
  }

  function toggleYouUI(){
    const hasYou = $("youSel").value === "yes";
    $("youWhoWrap").style.display = hasYou ? "block" : "none";
    $("youAmtWrap").style.display = hasYou ? "block" : "none";
    if (hasYou) {
      if (!$("youWhoSel").value) $("youWhoSel").value = $("winnerSel").value;
    }
  }

  function renderSelectors(){
    buildOptions($("dealerSel"));
    buildOptions($("winnerSel"));
    buildOptions($("youWhoSel"));

    $("dealerSel").value = "0";
    $("winnerSel").value = "0";
    $("youWhoSel").value = $("winnerSel").value;

    renderWaterOptions();
    toggleYouUI();
  }

  function lookupAmount({type, water, payerIsDealer}){
    const row = LOOKUP[type]?.[water];
    if (!row) return null;
    return payerIsDealer ? row["åº„"] : row["å¹³"];
  }

  function typeLabel(t){
    return ({dao:"åˆ°ï¼ˆèƒ¡ç‰Œï¼‰", zimo:"è‡ªæ‘¸", danyou:"å–®æ¸¸", shuangyou:"é›™æ¸¸"}[t] || t);
  }

  function addRound(){
    const dealer = Number($("dealerSel").value);
    const winner = Number($("winnerSel").value);
    const type = $("typeSel").value;
    const water = Number($("waterSel").value);
    const scale = Number($("scale").value || 1);

    if ((type === "danyou" || type === "shuangyou") && water === 0){
      alert("å–®æ¸¸/é›™æ¸¸çš„æ°´=0 åœ¨æ°´è¡¨æ˜¯ç„¡æ•ˆï¼ˆâ€”ï¼‰ã€‚è«‹é¸ 1ï½12ã€‚");
      return;
    }

    let lines = [];

    // ä¸‰å®¶è³ çµ¦è´å®¶ï¼ˆä¾è¼¸å®¶æ˜¯å¦ç‚ºèŠå®¶æŸ¥è¡¨ï¼‰
    for (let i=0;i<players.length;i++){
      if (i === winner) continue;

      const raw = lookupAmount({type, water, payerIsDealer: (i === dealer)});
      if (raw == null){
        alert("æŸ¥è¡¨å¤±æ•—ï¼šè«‹ç¢ºèªè´æ³•èˆ‡æ°´æ•¸æ˜¯å¦æœ‰æ•ˆã€‚");
        return;
      }
      const amount = raw * scale;
      lines.push({
        from:i,
        to:winner,
        amount,
        raw:`æŸ¥è¡¨ ${raw} Ã— å€ç‡ ${scale}`,
        role:(i===dealer ? "åº„" : "å¹³")
      });
    }

    // æ¸¸é‡‘ï¼šæ¯å€‹éæ¸¸é‡‘è€…ï¼Œé¡å¤–ä»˜å›ºå®šé‡‘é¡çµ¦æ¸¸é‡‘è€…ï¼ˆä¸ä¹˜å€ç‡ï¼‰
    if ($("youSel").value === "yes") {
      const youWho = Number($("youWhoSel").value);
      const youAmt = Number($("youAmt").value || 0);

      if (!Number.isFinite(youAmt) || youAmt < 0) {
        alert("æ¸¸é‡‘åŠ çµ¦é‡‘é¡è«‹å¡«æ­£æ•¸ï¼ˆæˆ– 0ï¼‰ã€‚");
        return;
      }

      for (let i = 0; i < players.length; i++) {
        if (i === youWho) continue;
        lines.push({
          from: i,
          to: youWho,
          amount: youAmt,
          raw: `æ¸¸é‡‘ +${youAmt}`,
          role: "æ¸¸é‡‘"
        });
      }
    }

    rounds.push({dealer, winner, type, water, scale, lines});

    // UXï¼šæ¸¸é‡‘è€…é è¨­è·Ÿè‘—è´å®¶èµ°ï¼ˆä½ ä¹Ÿå¯æ‰‹å‹•æ”¹ï¼‰
    $("youWhoSel").value = $("winnerSel").value;

    renderAll();
    // æ‰‹æ©Ÿï¼šè¨˜å®Œè®“ä½ çœ‹åˆ°çµæœï¼ˆä¸å¼·åˆ¶è·³ï¼Œä¿æŒè‡ªç„¶ï¼‰
    // document.getElementById("roundList")?.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function removeRound(idx){
    rounds.splice(idx,1);
    renderAll();
  }
  window.removeRound = removeRound;

  function computeTotals(){
    const n = players.length;
    const totals = Array(n).fill(0);
    rounds.forEach(r=>{
      r.lines.forEach(L=>{
        totals[L.from] -= L.amount;
        totals[L.to]   += L.amount;
      });
    });
    return totals;
  }

  function settleTransfers(totals){
    const creditors = [];
    const debtors = [];
    totals.forEach((amt,i)=>{
      const a = Math.round(amt*100)/100;
      if (a > 0) creditors.push({i, amt:a});
      else if (a < 0) debtors.push({i, amt:-a});
    });

    let res = [];
    let ci=0, di=0;
    while(ci<creditors.length && di<debtors.length){
      const c = creditors[ci], d = debtors[di];
      const pay = Math.min(c.amt, d.amt);
      if (pay > 0.000001) res.push({from:d.i, to:c.i, amount:pay});
      c.amt -= pay; d.amt -= pay;
      if (c.amt <= 0.000001) ci++;
      if (d.amt <= 0.000001) di++;
    }
    return res;
  }

  function badgeIf(name, should){
    return should ? `${name}<span class="badge">ğŸŸ¡æ¸¸é‡‘</span>` : name;
  }

  function renderRoundList(){
    if (!rounds.length){
      $("roundList").innerHTML = `<div class="muted">å°šæœªè¨˜éŒ„å±€æ•¸ã€‚</div>`;
      return;
    }

    $("roundList").innerHTML = rounds.map((r,idx)=>{
      // æ‰¾æ¸¸é‡‘è€…ï¼šæœ¬å±€è‹¥æœ‰ä»»ä½• role === "æ¸¸é‡‘" çš„ lineï¼Œå–ç¬¬ä¸€ç­†çš„ to
      const youLine = r.lines.find(L => L.role === "æ¸¸é‡‘");
      const youWho = youLine ? youLine.to : null;

      const dealerName = badgeIf(escapeHtml(players[r.dealer]), youWho === r.dealer);
      const winnerName = badgeIf(escapeHtml(players[r.winner]), youWho === r.winner);

      const title = `ç¬¬ ${idx+1} å±€ï½œèŠï¼š${dealerName}ï½œè´ï¼š${winnerName}ï½œ${typeLabel(r.type)}ï½œ${r.water} æ°´`;

      const lines = r.lines.map(L=>{
        return `${escapeHtml(players[L.from])}ï¼ˆ${escapeHtml(L.role)}ï¼‰ â†’ ${escapeHtml(players[L.to])}ï¼š${fmtMoney(L.amount)} <span class="muted">(${escapeHtml(L.raw)})</span>`;
      }).join("<br>");

      return `
        <div class="card roundCard">
          <div class="roundHeader">
            <div class="roundTitle"><strong>${title}</strong></div>
            <button onclick="removeRound(${idx})">åˆªé™¤æœ¬å±€</button>
          </div>
          <div class="mono roundLines">${lines}</div>
        </div>
      `;
    }).join("");
  }

  function renderTotalsAndTransfers(){
    const totals = computeTotals();
    const sum = Math.round(totals.reduce((a,b)=>a+b,0)*100)/100;

    const totalsRows = totals.map((amt,i)=>`
      <tr>
        <td>${escapeHtml(players[i])}</td>
        <td class="mono">${amt>=0?"+":""}${fmtMoney(amt)}</td>
      </tr>
    `).join("");

    $("totalsArea").innerHTML = `
      <div class="${Math.abs(sum) < 0.01 ? "ok" : "warn"}">
        ${Math.abs(sum) < 0.01 ? "ç¸½å’Œ OKï¼ˆæ”¶æ”¯å¹³è¡¡ï¼‰" : `è­¦å‘Šï¼šç¸½å’Œä¸ç‚º 0ï¼ˆç›®å‰ ${fmtMoney(sum)}ï¼‰`}
      </div>
      <table>
        <thead><tr><th>ç©å®¶</th><th>ç¸½è¼¸è´ï¼ˆé‡‘é¡ï¼‰</th></tr></thead>
        <tbody>${totalsRows}</tbody>
      </table>
    `;

    const transfers = settleTransfers(totals);
    if (!transfers.length){
      $("transfersArea").innerHTML = `<div class="muted">ç›®å‰ç„¡éœ€è½‰å¸³ï¼ˆæˆ–å°šæœªè¨˜éŒ„å±€æ•¸ï¼‰ã€‚</div>`;
      return;
    }

    $("transfersArea").innerHTML = `
      <table>
        <thead><tr><th>èª°ä»˜</th><th></th><th>ä»˜çµ¦èª°</th><th>é‡‘é¡</th></tr></thead>
        <tbody>
          ${transfers.map(t=>`
            <tr>
              <td>${escapeHtml(players[t.from])}</td>
              <td>â†’</td>
              <td>${escapeHtml(players[t.to])}</td>
              <td class="mono">${fmtMoney(t.amount)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderAll(){
    renderRoundList();
    renderTotalsAndTransfers();
  }

  function resetAll(){
    rounds = [];
    renderNames();
    renderSelectors();
    renderAll();
  }

  // ---- Events ----
  $("typeSel").addEventListener("change", renderWaterOptions);
  $("playerCount").addEventListener("change", resetAll);
  $("resetBtn").addEventListener("click", resetAll);
  $("addRoundBtn").addEventListener("click", addRound);
  $("clearRoundsBtn").addEventListener("click", ()=>{ rounds=[]; renderAll(); });

  $("youSel").addEventListener("change", toggleYouUI);
  $("winnerSel").addEventListener("change", ()=>{
    $("youWhoSel").value = $("winnerSel").value;
  });

  $("themeBtn").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  // åº•éƒ¨æ“ä½œåˆ—ï¼šç›´æ¥è§¸ç™¼åŸæœ¬æŒ‰éˆ•ï¼ˆä¸æ”¹é‚è¼¯ï¼‰
  $("addRoundBtnBottom").addEventListener("click", ()=> $("addRoundBtn").click());
  $("resetBtnBottom").addEventListener("click", ()=> $("resetBtn").click());
  $("themeBtnBottom").addEventListener("click", ()=> $("themeBtn").click());

  // ---- init ----
  initTheme();
  renderNames();
  renderSelectors();
  renderAll();
</script>
</body>
</html>
